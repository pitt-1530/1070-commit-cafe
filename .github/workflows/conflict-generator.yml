name: Conflict Generator

on:
  push:
    branches-ignore:
      - main

permissions:
  contents: write

jobs:
  update_main_after_branch_creation:
    runs-on: ubuntu-latest

    # Skip template repo and bot triggers
    if: github.repository != 'pitt-1530/1070-commit-cafe' &&
        github.actor != 'github-actions' &&
        github.actor != 'ConflictBot' &&
        github.actor != 'dependabot[bot]'

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Get branch info
        id: meta
        run: |
          BRANCH=${GITHUB_REF#refs/heads/}
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "Actor: $GITHUB_ACTOR"
          echo "Branch: $BRANCH"

      - name: Configure Git
        run: |
          git config user.name  "ConflictBot"
          git config user.email "conflict-bot@nvf.pitt.edu"

      # Detect whether this is the student's first real commit on the new branch
      - name: Count new commits on this branch relative to main
        id: branchcheck
        run: |
          git fetch origin main --prune
          COUNT=$(git rev-list --count origin/main..HEAD)
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "New commits on this branch: $COUNT"
          
      - name: Generate merge conflict
        if: steps.branchcheck.outputs.count == '1'
        run: |
          echo "Creating commit on main due to new student branch commit"

          git fetch origin main
          git checkout -b update-main origin/main

          # Inject pun
          python3 .github/scripts/inject.py CommitCafe.java
          
          git add CommitCafe.java
          git commit -m "Update print statement"
          git push origin update-main:main

      - name: Complete
        run: echo "Workflow finished."
